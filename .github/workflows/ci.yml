name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  lint-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Lint
        run: ruff check app src tests

      - name: Compile source tree
        run: python -m compileall app src tests

      - name: Run tests
        run: pytest -q

      - name: Validate migration files
        run: |
          python src/check_migrations.py --skip-db-check --output-json migration-check-report.json

      - name: CLI smoke check
        run: |
          python src/load_reco.py --help
          python src/replay_outbox.py --help
          python src/check_guardrails.py --help
          python src/check_migrations.py --help
          python src/smoke_stack.py --help

      - name: Draft release notes artifact
        run: |
          {
            echo "# Release Notes Draft"
            echo
            echo "Generated at: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            echo
            git log --pretty=format:'- %h %s' -n 30
          } > release-notes-draft.md

      - name: Upload lint/test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lint-test-artifacts-${{ github.run_id }}
          path: |
            migration-check-report.json
            release-notes-draft.md

  docker-smoke:
    runs-on: ubuntu-latest
    needs: lint-test
    timeout-minutes: 40
    env:
      APP_ENV: dev
      LOG_FORMAT: json
      LOG_LEVEL: INFO
      POSTGRES_DB: recsys
      POSTGRES_USER: recsys
      POSTGRES_PASSWORD: recsys_ci_password
      DATABASE_URL: postgresql://recsys:recsys_ci_password@postgres:5432/recsys
      DB_INIT_ON_STARTUP: "true"
      UVICORN_WORKERS: "1"
      PROMETHEUS_METRICS_ENABLED: "true"
      ONLINE_CACHE_ENABLED: "true"
      ONLINE_CACHE_BACKEND: redis
      OUTBOX_RELAY_STARTUP_MAX_RETRIES: "30"
      FEATURE_CONSUMER_STARTUP_MAX_RETRIES: "30"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Validate compose
        run: docker compose config > /tmp/docker-compose.rendered.yml

      - name: Build image
        run: docker build -t recsys-api:ci .

      - name: Start stack
        run: docker compose up -d --build

      - name: Wait for readiness
        run: |
          for i in $(seq 1 90); do
            if curl -fsS http://localhost:8080/readyz > readyz.json; then
              cat readyz.json
              exit 0
            fi
            sleep 2
          done
          echo "::error::API did not become ready in time"
          docker compose ps
          exit 1

      - name: End-to-end smoke scenario
        run: |
          python src/smoke_stack.py \
            --base-url http://localhost:8080 \
            --timeout-sec 2.5 \
            --ready-timeout-sec 60 \
            --outbox-timeout-sec 120 \
            --output-json smoke-report.json

      - name: Load test /reco
        run: |
          python src/load_reco.py \
            --base-url http://localhost:8080 \
            --warmup 50 \
            --requests 400 \
            --concurrency 20 \
            --k 20 \
            --timeout-sec 2.5 \
            --autolog-impressions \
            --output-json load-report.json

      - name: Evaluate guardrails
        run: |
          curl -fsS "http://localhost:8080/analytics/baseline?days=1" -o baseline-kpi.json
          curl -fsS "http://localhost:8080/contract" -o contract.json
          curl -fsS "http://localhost:8080/metrics/reco" -o reco-metrics.json
          python src/check_guardrails.py \
            --baseline-json baseline-kpi.json \
            --contract-json contract.json \
            --reco-metrics-json reco-metrics.json \
            --min-sla-samples 1 \
            --output-json guardrail-report.json

      - name: Validate applied migrations and checksums
        run: |
          python src/check_migrations.py \
            --database-url postgresql://recsys:recsys_ci_password@localhost:5432/recsys \
            --output-json migration-live-report.json

      - name: Upload smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-smoke-artifacts-${{ github.run_id }}
          path: |
            readyz.json
            smoke-report.json
            load-report.json
            baseline-kpi.json
            contract.json
            reco-metrics.json
            guardrail-report.json
            migration-live-report.json

      - name: Print compose logs on failure
        if: failure()
        run: docker compose logs --no-color --timestamps

      - name: Stop stack
        if: always()
        run: docker compose down -v
